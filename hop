repeat task.wait() until game:IsLoaded()

--// ==================== SERVICES ====================
local Players = game:GetService("Players")
local Lighting = game:GetService("Lighting")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")
local LP = Players.LocalPlayer

--// ==================== CONFIG ====================
local WHITE_ON_START = true              -- b·∫≠t m√†n h√¨nh tr·∫Øng khi load
local WHITE_TOGGLE_KEY = Enum.KeyCode.P  -- ph√≠m toggle tr·∫Øng
local ENABLE_LOW_GFX = true              -- b·∫≠t t·ªëi ∆∞u ƒë·ªì h·ªça
local HARD_HIDE_ALL_PARTS = true         -- ·∫©n to√†n b·ªô map tr·ª´ nh√¢n v·∫≠t
local TRACK_NEW_PARTS = true             -- t·ª± ·∫©n part m·ªõi
local PART_SCAN_INTERVAL = 1.0           -- qu√©t l·∫°i m·ªói 1s
local MAX_HIDE_PER_TICK = 1500           -- tr√°nh lag khi ·∫©n nhi·ªÅu part

--// ==================== WHITE SCREEN + TIMER ====================
local WhiteGui, WhiteFrame, TimerLabel, WhiteOn = nil, nil, nil, false
local startTime = tick()

local function getPlayerGui()
	local pg = LP:FindFirstChildOfClass("PlayerGui")
	if pg then return pg end
	repeat task.wait()
		pg = LP:FindFirstChildOfClass("PlayerGui")
	until pg
	return pg
end

local function ensureWhite()
	if WhiteGui and WhiteGui.Parent then return end

	local pg = getPlayerGui()
	WhiteGui = Instance.new("ScreenGui")
	WhiteGui.Name = "TP_WhiteOverlay"
	WhiteGui.ResetOnSpawn = false
	WhiteGui.IgnoreGuiInset = true
	WhiteGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
	WhiteGui.Parent = pg

	WhiteFrame = Instance.new("Frame")
	WhiteFrame.Size = UDim2.fromScale(1, 1)
	WhiteFrame.BackgroundColor3 = Color3.new(1, 1, 1)
	WhiteFrame.BorderSizePixel = 0
	WhiteFrame.Visible = false
	WhiteFrame.Parent = WhiteGui

	TimerLabel = Instance.new("TextLabel")
	TimerLabel.Size = UDim2.new(0, 300, 0, 100)
	TimerLabel.Position = UDim2.fromScale(0.5, 0.5)
	TimerLabel.AnchorPoint = Vector2.new(0.5, 0.5)
	TimerLabel.BackgroundTransparency = 1
	TimerLabel.Text = "00:00:00"
	TimerLabel.TextColor3 = Color3.new(0, 0, 0)
	TimerLabel.TextSize = 48
	TimerLabel.Font = Enum.Font.GothamBold
	TimerLabel.TextStrokeTransparency = 0.8
	TimerLabel.Parent = WhiteFrame
end

local function setWhite(b)
	ensureWhite()
	WhiteOn = b and true or false
	WhiteFrame.Visible = WhiteOn
end

UIS.InputBegan:Connect(function(i, gp)
	if gp then return end
	if i.KeyCode == WHITE_TOGGLE_KEY then
		setWhite(not WhiteOn)
	end
end)

if WHITE_ON_START then
	setWhite(true)
end

RunService.RenderStepped:Connect(function()
	if TimerLabel then
		local elapsed = tick() - startTime
		local h = math.floor(elapsed / 3600)
		local m = math.floor((elapsed % 3600) / 60)
		local s = math.floor(elapsed % 60)
		TimerLabel.Text = string.format("%02d:%02d:%02d", h, m, s)
	end
end)

--// ==================== LOW GRAPHICS ====================
if ENABLE_LOW_GFX then
	pcall(function()
		local rs = settings():GetService("RenderSettings")
		if rs then
			rs.QualityLevel = Enum.QualityLevel.Level01
		end

		Lighting.GlobalShadows = false
		Lighting.EnvironmentDiffuseScale = 0
		Lighting.EnvironmentSpecularScale = 0
		Lighting.ShadowSoftness = 0
		Lighting.Brightness = 1

		for _, v in ipairs(Lighting:GetChildren()) do
			if v:IsA("BloomEffect") or v:IsA("SunRaysEffect")
				or v:IsA("DepthOfFieldEffect")
				or v:IsA("BlurEffect")
				or v:IsA("ColorCorrectionEffect") then
				pcall(function() v.Enabled = false end)
			end
		end

		local ter = workspace:FindFirstChildOfClass("Terrain")
		if ter then
			ter.WaterWaveSize = 0
			ter.WaterWaveSpeed = 0
			ter.WaterReflectance = 0
			ter.WaterTransparency = 1
		end
	end)
end

--// ==================== HIDE MAP ====================
local function isDescendantOf(a, b)
	if not (a and b) then return false end
	local p = a
	while p do
		if p == b then return true end
		p = p.Parent
	end
	return false
end

local function isLocalCharacterPart(part)
	local char = LP and LP.Character
	return char and isDescendantOf(part, char)
end

local hiddenCount = 0

local function hidePart(p)
	if not (p and p:IsA("BasePart")) then return end
	if isLocalCharacterPart(p) then return end
	if p.LocalTransparencyModifier ~= 1 then
		p.LocalTransparencyModifier = 1
		p.CastShadow = false
		hiddenCount += 1
	end
end

local function initialHideAll()
	if not HARD_HIDE_ALL_PARTS then return end
	hiddenCount = 0

	local ok, desc = pcall(workspace.GetDescendants, workspace)
	if ok and type(desc) == "table" then
		local processed = 0
		for i = 1, #desc do
			local d = desc[i]

			if d:IsA("BasePart") then
				hidePart(d)
			end

			if ENABLE_LOW_GFX then
				if d:IsA("ParticleEmitter") or d:IsA("Trail")
					or d:IsA("Fire") or d:IsA("Smoke")
					or d:IsA("Sparkles") then
					pcall(function() d.Enabled = false end)
				elseif d:IsA("Decal") or d:IsA("Texture") then
					pcall(function() d.Transparency = 1 end)
				elseif d:IsA("SurfaceAppearance") then
					pcall(function() d:Destroy() end)
				elseif d:IsA("MeshPart") then
					pcall(function() d.RenderFidelity = Enum.RenderFidelity.Performance end)
				end
			end

			processed += 1
			if processed % MAX_HIDE_PER_TICK == 0 then
				task.wait()
			end
		end
	end

	print(("[CT] Map hidden: %d parts"):format(hiddenCount))
end

initialHideAll()

--// ==================== AUTO TRACK NEW PARTS ====================
if TRACK_NEW_PARTS and HARD_HIDE_ALL_PARTS then
	workspace.DescendantAdded:Connect(function(inst)
		if inst:IsA("BasePart") then
			hidePart(inst)
		end
	end)

	task.spawn(function()
		while task.wait(PART_SCAN_INTERVAL) do
			local ok, desc = pcall(workspace.GetDescendants, workspace)
			if ok and type(desc) == "table" then
				local processed = 0
				for i = 1, #desc do
					local d = desc[i]
					if d:IsA("BasePart") then
						hidePart(d)
					end
					processed += 1
					if processed % MAX_HIDE_PER_TICK == 0 then
						task.wait()
					end
				end
			end
		end
	end)
end
-- ==================================================
-- 3) ·∫®N B·∫¢NG L·ªñI TELEPORT
-- ==================================================
task.spawn(function()
    while task.wait(3) do
        pcall(function()
            local pg = LP:FindFirstChild('PlayerGui')
            if pg then
                for _, gui in ipairs(pg:GetChildren()) do
                    if gui:IsA('ScreenGui') and gui.Enabled then
                        for _, frame in ipairs(gui:GetDescendants()) do
                            if frame:IsA('Frame') or frame:IsA('ImageLabel') then
                                for _, textObj in ipairs(frame:GetDescendants()) do
                                    if textObj:IsA('TextLabel') or textObj:IsA('TextButton') then
                                        local text = string.lower(textObj.Text or '')
                                        local errorKeywords = { '772' }
                                        local isError = false
                                        for _, kw in ipairs(errorKeywords) do
                                            if text:find(kw) then isError = true break end
                                        end
                                        if isError then
                                            frame.Visible = false
                                            gui.Enabled = false
                                            print('üö´ ƒê√£ ·∫©n b·∫£ng l·ªói:', textObj.Text)
                                            for _, btn in ipairs(frame:GetDescendants()) do
                                                if btn:IsA('TextButton') then
                                                    local btnText = string.lower(btn.Text or '')
                                                    if btnText:find('ok') or btnText:find('ƒë√≥ng') or btnText:find('close') then
                                                        pcall(function()
                                                            for _, connection in pairs(getconnections(btn.MouseButton1Click)) do
                                                                connection:Fire()
                                                            end
                                                        end)
                                                    end
                                                end
                                            end
                                            break
                                        end
                                    end
                                end
                            end
                        end
                    end
                end

                pcall(function()
                    local coreGui = game:GetService('CoreGui')
                    for _, gui in ipairs(coreGui:GetChildren()) do
                        if gui:IsA('ScreenGui') then
                            for _, desc in ipairs(gui:GetDescendants()) do
                                if desc:IsA('TextLabel') then
                                    local text = string.lower(desc.Text or '')
                                    if text:find('772') or text:find('773') then
                                        gui.Enabled = false
                                    end
                                end
                            end
                        end
                    end
                end)
            end
        end)
    end
end)
-- ==================================================
-- ‚öôÔ∏è LOCAL TARGET C≈® (d√πng cho isTarget + webhook)
-- ==================================================
local targets = {
    'Chipso and Queso','La Casa Boo','Tang Tang Keletang','Headless Horseman',
    'Burrito Bandito','Strawberry Elephant','Chicleteira Bicicleteira','Los Chicleteiras',
    'La Grande Combinasion','Nuclearo Dinossauro','Esok Sekolah','Ketupat Kepat',
    'Money Money Puggy','Tictac Sahur','Ketchuru and Musturu','Garama and Madundung',
    'Spaghetti Tualetti','Dragon Cannelloni','67','Mariachi Corazoni','Tacorita Bicicleta',
    'La Extinct Grande','Quesadilla Crocodila','Los Nooo My Hotspotsitos','Las Sis',
    'Celularcini Viciosini','Los Bros','Tralaledon','Los Tacoritas','Los Primos',
    'Chillin Chili','Los Combinasionas','Los Hotspotsitos','La Supreme Combinasion',
    'Los 67','La Secret Combinasion','Burguro And Fryuro','La Spooky Grande','Los Mobilis',
    'Eviledon','Spooky and Pumpky','Mieteteira Bicicleteira','Los Spooky Combinasionas','Meowl',
    'Los Matteos','Bisonte Guppitere','La Vacca Saturno Saturnita','Los Spiderinis','Los Tralaleritos',
    'Yess My Examine','Las Tralaleritas','Job Job Job Sahur','Las Vaquitas Saturnitas','1x1x1x1','Guest 666',
    'Captiano Moby','La Taco Combinasion','Los Puggies','Los Spaghettis','Fragrama and Chocrama'
}

-- ==================================================
-- ‚öôÔ∏è H√ÄM CHUY·ªÇN GENERATION ‚Üí S·ªê (tri·ªáu M)
-- ==================================================
local function parseGeneration(gen)
    if not gen or gen == "" then return 0 end
    gen = tostring(gen):gsub(",", ""):gsub("%s+", ""):upper()
    local num = tonumber(gen:match("([%d%.]+)")) or 0

    if gen:find("B") then
        return num * 1000
    elseif gen:find("M") then
        return num
    elseif gen:find("K") then
        return num / 1000
    elseif gen:find("%$") then
        if num >= 1e9 then return (num / 1e9) * 1000
        elseif num >= 1e6 then return num / 1e6
        elseif num >= 1e3 then return num / 1e3 / 1000
        else return num / 1e6 end
    else
        return num
    end
end

-- ==================================================
-- ‚öôÔ∏è KI·ªÇM TRA TARGET (d√πng local targets c≈©)
-- ==================================================
local function isTarget(name)
    local n = string.lower(name or "")
    for _, t in ipairs(targets) do
        if n:find(string.lower(t), 1, true) then
            return true
        end
    end
    return false
end

-- ==================================================
-- ‚öôÔ∏è LOCAL SPECIAL TARGET (ch·ªâ d√πng cho HIGH delay 10s)
-- ==================================================
local highSpecialTargets = {
    'Headless Horseman','Meowl','Dragon Cannelloni',
    'Garama and Madundung','Spooky and Pumpky','Burguro And Fryuro',
    'Tang Tang Keletang','Captiano Moby','La Taco Combinasion','Fragrama and Chocrama',
    'La Secret Combinasion','Strawberry Elephant','Ketchuru and Musturu','Eviledon',
}

local function isHighSpecial(name)
    local n = string.lower(name or "")
    for _, s in ipairs(highSpecialTargets) do
        if n:find(string.lower(s), 1, true) then
            return true
        end
    end
    return false
end

-- ==================================================
-- ‚öôÔ∏è WEBHOOK LINKS (NH∆Ø C≈®)
-- ==================================================
local webhook_low     = "https://discord.com/api/webhooks/1426862131856412692/J-zZnc1SmoilRJLLU7gACiwH2No_kUfywubRLkAU2XfsLdFAjgmolpTTCk6RbtSE8VJg"
local webhook_high    = "https://discord.com/api/webhooks/1426864245143900202/bnRk09C0FuWUKrsx6HFakrgl5UC6ihPHWIrxRknE4VKDH7z-PAzWUvcLXrDwL4LsO9Yy"
local webhook_index   = "https://discord.com/api/webhooks/1437032441226203277/qvgc98yhyfH1SjZuE086LbabJV7He3ZO84Ve6US143l9OHxbwRfAAPqN97SLSZokMSPY"
local webhook_special = "https://discord.com/api/webhooks/1437032661188218932/CWZrxOaTlBJUSmkcPkFUHw_deJ9XaDjWsV8FGd8KN8NFZni7-GnCA2Yeap6fCAbdx1nE"

-- ==================================================
-- ‚öôÔ∏è HTTP REQUEST (t∆∞∆°ng th√≠ch executor)
-- ==================================================
local http_request_impl = nil
if typeof(syn) == "table" and typeof(syn.request) == "function" then
    http_request_impl = syn.request
elseif typeof(http_request) == "function" then
    http_request_impl = http_request
elseif typeof(request) == "function" then
    http_request_impl = request
elseif typeof(http) == "table" and typeof(http.request) == "function" then
    http_request_impl = http.request
end

local sendQueue, sending = {}, false
local function processQueue()
    if sending then return end
    sending = true
    while #sendQueue > 0 do
        local item = table.remove(sendQueue, 1)
        if not http_request_impl then
            warn("‚ùå Kh√¥ng c√≥ http_request_impl, b·ªè qua g·ª≠i Discord.")
            break
        end
        local ok, res = pcall(function()
            return http_request_impl({
                Url = item.url,
                Method = "POST",
                Headers = {["Content-Type"] = "application/json"},
                Body = HttpService:JSONEncode(item.payload),
            })
        end)
        if ok and res and (res.StatusCode == 204 or res.StatusCode == 200) then
            print("üì§ Webhook OK ‚Üí", item.url)
        else
            warn("‚ö†Ô∏è Webhook l·ªói:", res and res.StatusCode, res and res.Body)
            table.insert(sendQueue, item)
            task.wait(2)
        end
        task.wait(0.5)
    end
    sending = false
end

local function safeSend(url, payload)
    table.insert(sendQueue, {url=url, payload=payload})
    task.spawn(processQueue)
end

-- ==================================================
-- ‚öôÔ∏è EMBED FULL (low/high/special) - GI·ªÆ NGUY√äN
-- ==================================================
local function makePayload(list, color, placeId, jobId)
    local players = tostring(#Players:GetPlayers()).."/"..tostring(Players.MaxPlayers)
    local lines = {}
    table.insert(lines, ("üë• Players: %s"):format(players))
    table.insert(lines, "üè∑Ô∏è Name              üí∞ Money/s")
    local COLUMN_POS = 22
    for _, t in ipairs(list) do
        local name = t.name or "Unknown"
        local gen  = t.generation or "?"
        if utf8.len(name) > COLUMN_POS - 2 then
            name = string.sub(name, 1, COLUMN_POS - 5) .. "..."
        end
        local pad = math.max(0, COLUMN_POS - utf8.len(name))
        table.insert(lines, string.format("%s%s%s", name, string.rep(" ", pad), gen))
    end
    local tableBlock = "```\n" .. table.concat(lines, "\n") .. "\n```"

    local joinLink = ("üåê [**JOIN SERVER HERE**](https://chillihub1.github.io/chillihub-joiner/?placeId=%s&gameInstanceId=%s)")
        :format(placeId, jobId)
    local joinScript = string.format(
        "```lua\ngame:GetService('TeleportService'):TeleportToPlaceInstance(%s, '%s', game.Players.LocalPlayer)\n```",
        placeId, jobId
    )
    local footerTime = ("Made by Grape Hub | H√¥m nay l√∫c %s:%s"):format(os.date("%H"), os.date("%M"))

    return {
        embeds = {{
            author = {name = "Brainrot Notify | Grape Hub"},
            color  = color or 0x000000,
            description = tableBlock ..
                "\nüÜî **Job ID (PC):** `" .. jobId .. "`\n" ..
                joinLink .. "\n\nüìú **Join Script:**\n" .. joinScript,
            footer = {text = footerTime},
        }}
    }
end

-- ==================================================
-- ‚öôÔ∏è EMBED INDEX (ch·ªâ t√™n + ti·ªÅn) - GI·ªÆ NGUY√äN
-- ==================================================
local function makeIndexPayload(list)
    local lines = {}
    table.insert(lines, "üè∑Ô∏è Name              üí∞ Money/s")
    local COLUMN_POS = 22
    for _, t in ipairs(list) do
        local name = t.name or "Unknown"
        local gen  = t.generation or "?"
        if utf8.len(name) > (COLUMN_POS - 2) then
            name = string.sub(name, 1, COLUMN_POS - 5) .. "..."
        end
        local pad = math.max(0, COLUMN_POS - utf8.len(name))
        table.insert(lines, string.format("%s%s%s", name, string.rep(" ", pad), gen))
    end
    local tableBlock = "```\n" .. table.concat(lines, "\n") .. "\n```"
    local footerTime = ("Made by Grape Hub | H√¥m nay l√∫c %s:%s"):format(os.date("%H"), os.date("%M"))

    return {
        embeds = {{
            author = {name = "Brainrot Notify | Grape Hub"},
            color  = 0x000000,
            description = tableBlock,
            footer = {text = footerTime},
        }}
    }
end

-- ==================================================
-- ‚öôÔ∏è H√ÄM CHIA LIST TH√ÄNH NHI·ªÄU CHUNK (tr√°nh embed b·ªã c·∫Øt)
-- ==================================================
local function chunkList(list, maxPerChunk)
    local result = {}
    local total = #list
    maxPerChunk = maxPerChunk or 30

    for i = 1, total, maxPerChunk do
        local chunk = {}
        for j = i, math.min(i + maxPerChunk - 1, total) do
            table.insert(chunk, list[j])
        end
        table.insert(result, chunk)
    end

    return result
end
local lastJobIdSent = nil
local INDEX_DELAY_SEC       = 15
local HIGH_NORMAL_DELAY_SEC = 15
local HIGH_SPECIAL_DELAY_SEC= 20

local function sendWebhook(foundTargets)
    if not foundTargets or #foundTargets == 0 then return end

    local placeId, jobId = game.PlaceId, game.JobId
    if jobId == lastJobIdSent then return end
    lastJobIdSent = jobId

    local groupLow         = {}
    local groupUltra       = {} -- ultra/special 10M+ g·ª≠i li·ªÅn
    local groupIndex       = {} -- 10M+ cho index & high
    local groupHighNormal  = {} -- 10M+ kh√¥ng thu·ªôc special target ‚Üí delay 3s
    local groupHighSpecial = {} -- 10M+ thu·ªôc special target ‚Üí delay 10s

    --------------------------------------------------
    -- L·ªåC TARGET THEO GENERATION
    --------------------------------------------------
    for _, t in ipairs(foundTargets) do
        local name = t.name or "Unknown"
        local gen  = t.generation or "N/A"

        if not isTarget(name) then
            continue
        end

        local val = parseGeneration(gen)
        if val <= 0 then
            continue
        end

        if val >= 10 then
            local rec = {name = name, generation = gen}

            -- ULTRA: 10M+ kh√¥ng gi·ªõi h·∫°n, g·ª≠i li·ªÅn qua webhook_special
            table.insert(groupUltra, rec)

            -- INDEX + HIGH: chung 1 t·∫≠p
            table.insert(groupIndex, rec)

            -- HIGH chia nh·ªè ƒë·ªÉ delay kh√°c nhau
            if isHighSpecial(name) then
                table.insert(groupHighSpecial, rec)   -- delay 10s
            else
                table.insert(groupHighNormal, rec)    -- delay 3s
            end
        elseif val >= 1 then
            table.insert(groupLow, {name = name, generation = gen})
        end
    end

    if #groupLow == 0 and #groupUltra == 0 and #groupIndex == 0 then
        print("‚ÑπÔ∏è Kh√¥ng c√≥ target h·ª£p l·ªá ƒë·ªÉ g·ª≠i webhook.")
        return
    end

    print(string.format(
        "üì§ B·∫Øt ƒë·∫ßu g·ª≠i webhook ... Low=%d, Ultra=%d, Index=%d, HighNorm=%d, HighSpec=%d",
        #groupLow, #groupUltra, #groupIndex, #groupHighNormal, #groupHighSpecial
    ))

    ------------------------------------------------------
    -- üü° ULTRA (webhook_special): 10M+ g·ª≠i LI·ªÄN (full embed)
    ------------------------------------------------------
    if #groupUltra > 0 then
        local ultraChunks = chunkList(groupUltra, 30)
        for ci, chunk in ipairs(ultraChunks) do
            safeSend(webhook_special, makePayload(chunk, 0xFFD700, placeId, jobId))
            print(string.format(
                "üö® ULTRA 10M+: chunk %d/%d, %d item(s) g·ª≠i NGAY",
                ci, #ultraChunks, #chunk
            ))
        end
    end

    ------------------------------------------------------
    -- üîµ INDEX (webhook_index): 10M+ ‚Üí delay 15s, ch·ªâ t√™n + ti·ªÅn
    ------------------------------------------------------
    if #groupIndex > 0 then
        local indexChunks = chunkList(groupIndex, 40)
        print(string.format(
            "‚è±Ô∏è Index(10M+): s·∫Ω g·ª≠i sau %ds (%d item, %d chunk)",
            INDEX_DELAY_SEC, #groupIndex, #indexChunks
        ))

        task.delay(INDEX_DELAY_SEC, function()
            for ci, chunk in ipairs(indexChunks) do
                safeSend(webhook_index, makeIndexPayload(chunk))
                print(string.format(
                    "‚úÖ Index(10M+): chunk %d/%d, %d item(s) ƒë√£ g·ª≠i (delay %ds)",
                    ci, #indexChunks, #chunk, INDEX_DELAY_SEC
                ))
            end
        end)
    end

    ------------------------------------------------------
    -- üü¢ LOW (webhook_low): 1‚Äì9M ‚Üí g·ª≠i NGAY full info
    ------------------------------------------------------
    if #groupLow > 0 then
        safeSend(webhook_low, makePayload(groupLow, 0x00FF00, placeId, jobId))
        print(string.format(
            "üì© Low(1‚Äì9M): %d item(s) g·ª≠i NGAY (full info)",
            #groupLow
        ))
    end

    ------------------------------------------------------
    -- üî¥ HIGH (webhook_high): 10M+ gi·ªëng Index
    --   ‚Ä¢ normal: delay 3s
    --   ‚Ä¢ trong highSpecialTargets: delay 10s
    ------------------------------------------------------
    -- HIGH normal (delay 3s)
    if #groupHighNormal > 0 then
        local normChunks = chunkList(groupHighNormal, 30)
        print(string.format(
            "‚è±Ô∏è High NORMAL(10M+): s·∫Ω g·ª≠i sau %ds (%d item, %d chunk)",
            HIGH_NORMAL_DELAY_SEC, #groupHighNormal, #normChunks
        ))

        task.delay(HIGH_NORMAL_DELAY_SEC, function()
            for ci, chunk in ipairs(normChunks) do
                safeSend(webhook_high, makePayload(chunk, 0x1A1AFF, placeId, jobId))
                print(string.format(
                    "‚úÖ High NORMAL: chunk %d/%d, %d item(s) ƒë√£ g·ª≠i (delay %ds)",
                    ci, #normChunks, #chunk, HIGH_NORMAL_DELAY_SEC
                ))
            end
        end)
    end

    -- HIGH special (delay 20s)
    if #groupHighSpecial > 0 then
        local specChunks = chunkList(groupHighSpecial, 30)
        print(string.format(
            "‚è±Ô∏è High SPECIAL(10M+): s·∫Ω g·ª≠i sau %ds (%d item, %d chunk)",
            HIGH_SPECIAL_DELAY_SEC, #groupHighSpecial, #specChunks
        ))

        task.delay(HIGH_SPECIAL_DELAY_SEC, function()
            for ci, chunk in ipairs(specChunks) do
                safeSend(webhook_high, makePayload(chunk, 0x1A1AFF, placeId, jobId))
                print(string.format(
                    "‚úÖ High SPECIAL: chunk %d/%d, %d item(s) ƒë√£ g·ª≠i (delay %ds)",
                    ci, #specChunks, #chunk, HIGH_SPECIAL_DELAY_SEC
                ))
            end
        end)
    end
end
-- ==================================================
-- CHECK TARGETS + LOOP (gi·ªØ c∆° ch·∫ø qu√©t c≈©, qu√©t m·ªói 3s)
-- ==================================================
local function checkTargets()
    local foundTargets = {}
    for _, obj in ipairs(workspace:GetDescendants()) do
        if obj:IsA('TextLabel') and obj.Name == 'DisplayName' then
            local txt = string.lower(obj.LocalizedText or '')

            if string.upper(obj.LocalizedText or '') == 'FUSING' then
                continue
            end

            for _, name in ipairs(targets) do
                if string.find(txt, string.lower(name)) then
                    local parent = obj.Parent
                    local isStolen = false
                    local generation = 'N/A'

                    if parent then
                        local stolenLabel = parent:FindFirstChild('Stolen')
                        if stolenLabel and stolenLabel:IsA('TextLabel') then
                            local stolenText = string.upper(stolenLabel.LocalizedText or '')
                            if stolenText == 'FUSING' then
                                isStolen = true
                            end
                        end

                        for _, child in ipairs(parent:GetChildren()) do
                            if child:IsA('TextLabel') then
                                local childName = string.lower(child.Name or '')
                                local childText = child.LocalizedText or ''

                                if childName:find('generation') or childName:find('gen') then
                                    generation = childText ~= '' and childText or generation
                                    break
                                end

                                if childText:match('^G%d+') or childText:match('^G%d+%s') then
                                    generation = childText
                                    break
                                end
                            end
                        end
                    end

                    if not isStolen then
                        table.insert(foundTargets, { name = name, generation = generation })
                        print('‚úÖ Found valid target:', name, '| Generation:', generation)
                    else
                        print('‚ö†Ô∏è Skipped (FUSING):', name)
                    end
                    break
                end
            end
        end
    end
    return foundTargets
end

print('üéØ CT_WhiteScanner_V2 ƒëang ch·∫°y... (qu√©t m·ªói 3s)')

-- STARTUP: ƒë·ª£i map load billboard, retry 5s n·∫øu ch∆∞a c√≥
task.spawn(function()
    print("üïì ƒê·ª£i map load Billboard... (1s)")
    task.wait(1)
    local initialTargets = checkTargets()
    if #initialTargets > 0 then
        print("‚úÖ ƒê√£ t√¨m th·∫•y "..#initialTargets.." target, g·ª≠i ngay!")
        sendWebhook(initialTargets)
    else
        print("‚åõ Ch∆∞a ph√°t hi·ªán target n√†o, retry sau 1s...")
        task.delay(1, function()
            local retry = checkTargets()
            if #retry > 0 then
                print("üîÅ G·ª≠i l·∫°i webhook sau 1s ("..#retry.." targets)")
                sendWebhook(retry)
            else
                print("‚åõ Retry 1s: v·∫´n ch∆∞a c√≥ target.")
            end
        end)
    end
end)

-- Loop qu√©t ƒë·ªÅu ƒë·∫∑n
task.spawn(function()
    while task.wait(3) do
        local ok2, err = pcall(function()
            local t = checkTargets()
            if #t > 0 then sendWebhook(t) end
        end)
        if not ok2 then warn('‚ö†Ô∏è Scan loop error:', err) end
    end
end)
-- üöÄ CT AUTO JOIN ‚Äì poll 2s, retry 1s (gi·ªØ nguy√™n scan 8080‚Äì8095)
repeat task.wait() until game:IsLoaded()
task.wait(0.1)

local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local LocalPlayer = Players.LocalPlayer

-- HTTP ch·ªçn
local http_request_impl = (syn and syn.request)
    or (typeof(http_request)=="function" and http_request)
    or (typeof(request)=="function" and request)
    or (http and http.request)

if not http_request_impl then
    warn("‚ùå Kh√¥ng c√≥ HTTP.")
    return
end

-- ====== NEW TIMING (Y√äU C·∫¶U) ======
local POLL_INTERVAL = 2.0      -- 2 gi√¢y l·∫•y API 1 l·∫ßn
local RETRY_INTERVAL = 1.0     -- n·∫øu kh√¥ng c√≥ job ‚Üí ƒë·ª£i 1 gi√¢y r·ªìi l·∫•y l·∫°i
local AFTER_TP_WAIT = 0.15
-- ==================================

-- instance name
local function getInstanceName()
    local uid = tostring(LocalPlayer.UserId or 0)
    return LocalPlayer.Name .. "_" .. uid:sub(-2)
end
local INSTANCE = getInstanceName()

-- ====== GI·ªÆ NGUY√äN SCAN PORT 8080 ‚Üí 8095 NH∆ØNG CHO NHANH H∆†N ======
local function detectActivePort()
    local function tryPort(port)
        local url = ("http://127.0.0.1:%d/next?instance=%s"):format(port, INSTANCE)

        local ok,res = pcall(function()
            return http_request_impl({
                Url = url,
                Method = "GET",
                Timeout = 0.2       -- gi·∫£m t·ª´ 0.6 xu·ªëng 0.2
            })
        end)

        if not ok or not res then return nil end
        if res.StatusCode ~= 200 then return nil end
        if not res.Body or #res.Body == 0 then return nil end
        if tostring(res.Body):lower():find("error") then return nil end
        
        print("[CT AutoJoin] ‚úì Port", port)
        return url
    end

    for p = 8080, 8095 do
        local okURL = tryPort(p)
        if okURL then return okURL end
        task.wait(0.01)
    end

    warn("‚ö† Fallback port 8080.")
    return ("http://127.0.0.1:8080/next?instance=%s"):format(INSTANCE)
end

local HTTP_URL = detectActivePort()
print("[CT AutoJoin] START at", HTTP_URL)

-- dedupe
local recentSet = {}

local function pushRecent(jobId)
    recentSet[jobId] = true
end

-- l·ªách pha (gi·ªØ nguy√™n)
do
    local h=0
    for i=1,#INSTANCE do h=(h*131+INSTANCE:byte(i))%997 end
    local offset = (h % 300) / 1000
    task.wait(0.1 + offset)
end

-- ================== MAIN LOOP (FIXED 2s poll, 1s retry) ==================
task.spawn(function()
    while true do
        local ok_req, response = pcall(function()
            return http_request_impl({
                Url = HTTP_URL,
                Method = "GET"
            })
        end)

        local jobFound = false

        if ok_req and response and response.Body then
            local ok_json, data = pcall(function()
                return HttpService:JSONDecode(response.Body)
            end)
            if ok_json and type(data) == "table" then
                local jobId = tostring(data.jobId or "")
                local placeId = tonumber(data.placeId) or game.PlaceId

                if jobId ~= "" and jobId ~= "null" and not recentSet[jobId] then
                    jobFound = true
                    pushRecent(jobId)

                    print("üü¢ JOIN:", jobId)

                    pcall(function()
                        TeleportService:TeleportToPlaceInstance(placeId, jobId, LocalPlayer)
                    end)

                    task.wait(AFTER_TP_WAIT)
                end
            end
        end

        if jobFound then
            task.wait(POLL_INTERVAL) -- v·∫´n gi·ªØ 2s l·∫ßn ti·∫øp theo
        else
            task.wait(RETRY_INTERVAL) -- kh√¥ng c√≥ job ‚Üí retry sau 1s
        end
    end
end)
