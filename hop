-- CT_WhiteScanner_V2.lua (Grape Hub) - FULL (original mechanisms + improved webhook logic)
task.wait(1)
repeat task.wait() until game:IsLoaded()

--// Services
local Players     = game:GetService('Players')
local Lighting    = game:GetService('Lighting')
local RunService  = game:GetService('RunService')
local UIS         = game:GetService('UserInputService')
local HttpService = game:GetService('HttpService')
local LP          = Players.LocalPlayer

-- ==================================================
-- 1) T·ªêI ∆ØU ƒê·ªí H·ªåA / FIX LAG  (gi·ªØ nguy√™n c∆° ch·∫ø c≈©)
-- ==================================================
pcall(function()
    local rs = settings():GetService('RenderSettings')
    if rs then rs.QualityLevel = Enum.QualityLevel.Level01 end
end)
pcall(function()
    Lighting.GlobalShadows = false
    Lighting.EnvironmentDiffuseScale = 0
    Lighting.EnvironmentSpecularScale = 0
    Lighting.FogEnd = 1000
    Lighting.Brightness = 1
    Lighting.ClockTime = 12
    Lighting.ShadowSoftness = 0

    for _, v in ipairs(Lighting:GetChildren()) do
        if v:IsA('BloomEffect') or v:IsA('SunRaysEffect') or v:IsA('DepthOfFieldEffect')
        or v:IsA('BlurEffect') or v:IsA('ColorCorrectionEffect') then
            pcall(function() v.Enabled = false end)
        end
    end

    local function ensureEffect(cls, name)
        local eff = Lighting:FindFirstChild(name)
        if not eff then
            local bycls = Lighting:FindFirstChildOfClass(cls)
            if bycls then eff = bycls; eff.Name = name
            else eff = Instance.new(cls); eff.Name = name; eff.Parent = Lighting end
        end
        pcall(function() eff.Enabled = false end)
    end

    ensureEffect('SunRaysEffect', 'SunRays')
    ensureEffect('BloomEffect', 'Bloom')
    ensureEffect('DepthOfFieldEffect', 'DepthOfField')
    ensureEffect('BlurEffect', 'Blur')
    ensureEffect('ColorCorrectionEffect', 'ColorCorrection')
end)

pcall(function()
    local Terrain = workspace:FindFirstChildOfClass('Terrain')
    if Terrain then
        Terrain.WaterWaveSize = 0
        Terrain.WaterWaveSpeed = 0
        Terrain.WaterReflectance = 0
        Terrain.WaterTransparency = 1
    end
    workspace.StreamingEnabled = true
    workspace.LevelOfDetail = Enum.ModelLevelOfDetail.Disabled
end)

local okDesc, descs = pcall(workspace.GetDescendants, workspace)
if okDesc and type(descs) == 'table' then
    for _, inst in ipairs(descs) do
        if inst:IsA('BasePart') then
            pcall(function()
                inst.Material = Enum.Material.SmoothPlastic
                inst.CastShadow = false
                inst.Reflectance = 0
            end)
        elseif inst:IsA('ParticleEmitter') or inst:IsA('Trail') or inst:IsA('Fire')
            or inst:IsA('Smoke') or inst:IsA('Sparkles') then
            pcall(function() inst.Enabled = false end)
        elseif inst:IsA('Decal') or inst:IsA('Texture') then
            pcall(function()
                inst.Transparency = 1
                inst.ZIndex = 0
            end)
        elseif inst:IsA('SurfaceAppearance') then
            pcall(function() inst:Destroy() end)
        end
    end
end

print('‚úÖ ƒê√£ t·ªëi ∆∞u ƒë·ªì h·ªça xong!')

-- ==================================================
-- 2) WHITE SCREEN + TIMER (toggle b·∫±ng P) - gi·ªØ nguy√™n
-- ==================================================
local WHITE_ON_START = true
local TOGGLE_KEY = Enum.KeyCode.P
local WhiteGui, WhiteFrame, TimerLabel, WhiteOn = nil, nil, nil, false
local startTime = tick()

local function ensureWhite()
    if WhiteGui and WhiteGui.Parent then return end
    local pg = nil
    local ok = pcall(function() pg = LP and LP:WaitForChild('PlayerGui', 10) end)
    if not ok or not pg then warn('[WhiteScreen] PlayerGui not found'); return end

    WhiteGui = Instance.new('ScreenGui')
    WhiteGui.Name = 'WhiteOverlay'
    WhiteGui.ResetOnSpawn = false
    WhiteGui.IgnoreGuiInset = true
    WhiteGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    WhiteGui.Parent = pg

    WhiteFrame = Instance.new('Frame')
    WhiteFrame.Size = UDim2.fromScale(1, 1)
    WhiteFrame.BackgroundColor3 = Color3.new(1, 1, 1)
    WhiteFrame.BorderSizePixel = 0
    WhiteFrame.Visible = false
    WhiteFrame.Parent = WhiteGui

    TimerLabel = Instance.new('TextLabel')
    TimerLabel.Size = UDim2.new(0, 300, 0, 100)
    TimerLabel.Position = UDim2.fromScale(0.5, 0.5)
    TimerLabel.AnchorPoint = Vector2.new(0.5, 0.5)
    TimerLabel.BackgroundTransparency = 1
    TimerLabel.Text = '00:00:00'
    TimerLabel.TextColor3 = Color3.new(0, 0, 0)
    TimerLabel.TextSize = 48
    TimerLabel.Font = Enum.Font.GothamBold
    TimerLabel.TextStrokeTransparency = 0.8
    TimerLabel.Parent = WhiteFrame
end

local function setWhite(b)
    if not (WhiteGui and WhiteGui.Parent) then ensureWhite() end
    if not (WhiteGui and WhiteGui.Parent) then return end
    WhiteOn = b and true or false
    if WhiteFrame then WhiteFrame.Visible = WhiteOn end
end

pcall(function()
    UIS.InputBegan:Connect(function(input, gpe)
        if gpe then return end
        if input.KeyCode == TOGGLE_KEY then
            setWhite(not WhiteOn)
        end
    end)
end)

if WHITE_ON_START then setWhite(true) end

task.spawn(function()
    RunService.RenderStepped:Connect(function()
        if TimerLabel then
            local elapsed = tick() - startTime
            local hours = math.floor(elapsed / 3600)
            local minutes = math.floor((elapsed % 3600) / 60)
            local seconds = math.floor(elapsed % 60)
            TimerLabel.Text = string.format('%02d:%02d:%02d', hours, minutes, seconds)
        end
    end)
end)

-- ==================================================
-- 3) ·∫®N B·∫¢NG L·ªñI TELEPORT
-- ==================================================
task.spawn(function()
    while task.wait(3) do
        pcall(function()
            local pg = LP:FindFirstChild('PlayerGui')
            if pg then
                for _, gui in ipairs(pg:GetChildren()) do
                    if gui:IsA('ScreenGui') and gui.Enabled then
                        for _, frame in ipairs(gui:GetDescendants()) do
                            if frame:IsA('Frame') or frame:IsA('ImageLabel') then
                                for _, textObj in ipairs(frame:GetDescendants()) do
                                    if textObj:IsA('TextLabel') or textObj:IsA('TextButton') then
                                        local text = string.lower(textObj.Text or '')
                                        local errorKeywords = { '772' }
                                        local isError = false
                                        for _, kw in ipairs(errorKeywords) do
                                            if text:find(kw) then isError = true break end
                                        end
                                        if isError then
                                            frame.Visible = false
                                            gui.Enabled = false
                                            print('üö´ ƒê√£ ·∫©n b·∫£ng l·ªói:', textObj.Text)
                                            for _, btn in ipairs(frame:GetDescendants()) do
                                                if btn:IsA('TextButton') then
                                                    local btnText = string.lower(btn.Text or '')
                                                    if btnText:find('ok') or btnText:find('ƒë√≥ng') or btnText:find('close') then
                                                        pcall(function()
                                                            for _, connection in pairs(getconnections(btn.MouseButton1Click)) do
                                                                connection:Fire()
                                                            end
                                                        end)
                                                    end
                                                end
                                            end
                                            break
                                        end
                                    end
                                end
                            end
                        end
                    end
                end

                pcall(function()
                    local coreGui = game:GetService('CoreGui')
                    for _, gui in ipairs(coreGui:GetChildren()) do
                        if gui:IsA('ScreenGui') then
                            for _, desc in ipairs(gui:GetDescendants()) do
                                if desc:IsA('TextLabel') then
                                    local text = string.lower(desc.Text or '')
                                    if text:find('772') or text:find('773') then
                                        gui.Enabled = false
                                    end
                                end
                            end
                        end
                    end
                end)
            end
        end)
    end
end)
-- ==================================================
-- 4) TARGET LIST
-- ==================================================
local targets = {
    'Chipso and Queso','La Casa Boo','Tang Tang Keletang','Headless Horseman',
    'Burrito Bandito','Strawberry Elephant','Chicleteira Bicicleteira','Los Chicleteiras',
    'La Grande Combinasion','Nuclearo Dinossauro','Esok Sekolah','Ketupat Kepat',
    'Money Money Puggy','Tictac Sahur','Ketchuru and Musturu','Garama and Madundung',
    'Spaghetti Tualetti','Dragon Cannelloni','67','Mariachi Corazoni','Tacorita Bicicleta',
    'La Extinct Grande','Quesadilla Crocodila','Los Nooo My Hotspotsitos','Las Sis',
    'Celularcini Viciosini','Los Bros','Tralaledon','Los Tacoritas','Los Primos',
    'Chillin Chili','Los Combinasionas','Los Hotspotsitos','La Supreme Combinasion',
    'Los 67','La Secret Combinasion','Burguro And Fryuro','La Spooky Grande','Los Mobilis',
    'Eviledon','Spooky and Pumpky','Mieteteira Bicicleteira','Los Spooky Combinasionas','Meowl',
    'Los Matteos','Bisonte Guppitere','La Vacca Saturno Saturnita','Los Spiderinis','Los Tralaleritos',
    'Yess My Examine','Las Tralaleritas','Job Job Job Sahur','Las Vaquitas Saturnitas','1x1x1x1','Guest 666',
    'Captiano Moby','La Taco Combinasion','Los Puggies','Los Spaghettis','Fragrama and Chocrama'
}

-- ==================================================
-- ‚öôÔ∏è H√ÄM CHUY·ªÇN GENERATION ‚Üí S·ªê (tri·ªáu M)
-- ==================================================
local function parseGeneration(gen)
    if not gen or gen == "" then return 0 end
    gen = tostring(gen):gsub(",", ""):gsub("%s+", ""):upper()
    local num = tonumber(gen:match("([%d%.]+)")) or 0

    if gen:find("B") then
        return num * 1000              -- B ‚Üí t·ªâ = 1000M
    elseif gen:find("M") then
        return num                      -- M ‚Üí M
    elseif gen:find("K") then
        return num / 1000               -- K ‚Üí 0.001M
    elseif gen:find("%$") then          -- d·∫°ng $ s·ªë
        if     num >= 1e9 then return (num / 1e9) * 1000  -- $ ‚â• 1B ‚Üí 1000M
        elseif num >= 1e6 then return  num / 1e6          -- $ ‚â• 1M ‚Üí M
        elseif num >= 1e3 then return  num / 1e3 / 1000   -- $ ‚â• 1K ‚Üí 0.001M
        else return num / 1e6 end
    else
        return num
    end
end

-- ==================================================
-- ‚öôÔ∏è KI·ªÇM TRA TARGET (kh√¥ng ph√¢n bi·ªát hoa/th∆∞·ªùng)
-- ==================================================
local function isTarget(name)
    local n = string.lower(name or "")
    for _, t in ipairs(targets) do
        if n:find(string.lower(t), 1, true) then
            return true
        end
    end
    return false
end

-- ==================================================
-- ‚öôÔ∏è SPECIAL LIST
-- ==================================================
local specialList = {
    'Headless Horseman','Meowl','Dragon Cannelloni',
    'Garama and Madundung','Spooky and Pumpky','Burguro And Fryuro','Chipso and Queso'
}
local function isSpecial(name)
    local n = string.lower(name or "")
    for _, s in ipairs(specialList) do
        if n:find(string.lower(s), 1, true) then
            return true
        end
    end
    return false
end

-- ==================================================
-- ‚öôÔ∏è WEBHOOK LINKS
-- ==================================================
local webhook_low     = "https://discord.com/api/webhooks/1426862131856412692/J-zZnc1SmoilRJLLU7gACiwH2No_kUfywubRLkAU2XfsLdFAjgmolpTTCk6RbtSE8VJg"
local webhook_high    = "https://discord.com/api/webhooks/1426864245143900202/bnRk09C0FuWUKrsx6HFakrgl5UC6ihPHWIrxRknE4VKDH7z-PAzWUvcLXrDwL4LsO9Yy"
local webhook_index   = "https://discord.com/api/webhooks/1437032441226203277/qvgc98yhyfH1SjZuE086LbabJV7He3ZO84Ve6US143l9OHxbwRfAAPqN97SLSZokMSPY"
local webhook_special = "https://discord.com/api/webhooks/1437032661188218932/CWZrxOaTlBJUSmkcPkFUHw_deJ9XaDjWsV8FGd8KN8NFZni7-GnCA2Yeap6fCAbdx1nE"

-- ==================================================
-- ‚öôÔ∏è HTTP request (t∆∞∆°ng th√≠ch nhi·ªÅu executor) + QUEUE
-- ==================================================
local http_request_impl = nil
if typeof(syn) == "table" and typeof(syn.request) == "function" then
    http_request_impl = syn.request
elseif typeof(http_request) == "function" then
    http_request_impl = http_request
elseif typeof(request) == "function" then
    http_request_impl = request
elseif typeof(http) == "table" and typeof(http.request) == "function" then
    http_request_impl = http.request
end

local sendQueue, sending = {}, false
local function processQueue()
    if sending then return end
    sending = true
    while #sendQueue > 0 do
        local item = table.remove(sendQueue, 1)
        if not http_request_impl then
            warn("‚ùå Kh√¥ng c√≥ http_request_impl, b·ªè qua g·ª≠i Discord.")
            break
        end
        local ok, res = pcall(function()
            return http_request_impl({
                Url = item.url,
                Method = "POST",
                Headers = {["Content-Type"] = "application/json"},
                Body = HttpService:JSONEncode(item.payload),
            })
        end)
        if ok and res and (res.StatusCode == 204 or res.StatusCode == 200) then
            print("üì§ Webhook OK ‚Üí", item.url)
        else
            warn("‚ö†Ô∏è Webhook l·ªói:", res and res.StatusCode, res and res.Body)
            table.insert(sendQueue, item)  -- retry
            task.wait(2)
        end
        task.wait(0.5) -- anti rate limit
    end
    sending = false
end

local function safeSend(url, payload)
    table.insert(sendQueue, {url=url, payload=payload})
    task.spawn(processQueue)
end

-- ==================================================
-- ‚öôÔ∏è EMBED (full info cho LOW/HIGH/SPECIAL)
--  - D√πng os.date() ƒë·ªÉ tr√°nh l·ªói DateTime:FormatLocalTime
-- ==================================================
-- ==================================================
-- ‚öôÔ∏è EMBED (FULL TYPE ‚Äì d√πng cho low/high/special)
-- ==================================================
local function makePayload(list, color, placeId, jobId)
    local players = tostring(#Players:GetPlayers()).."/"..tostring(Players.MaxPlayers)

    -- B·∫£ng cƒÉn h√†ng
    local lines = {}
    table.insert(lines, ("üë• Players: %s"):format(players))
    table.insert(lines, "üè∑Ô∏è Name              üí∞ Money/s")
    local COLUMN_POS = 22
    for _, t in ipairs(list) do
        local name = t.name or "Unknown"
        local gen  = t.generation or "?"
        if utf8.len(name) > COLUMN_POS - 2 then
            name = string.sub(name, 1, COLUMN_POS - 5) .. "..."
        end
        local pad = math.max(0, COLUMN_POS - utf8.len(name))
        table.insert(lines, string.format("%s%s%s", name, string.rep(" ", pad), gen))
    end
    local tableBlock = "```\n" .. table.concat(lines, "\n") .. "\n```"

    local joinLink = ("üåê [**JOIN SERVER HERE**](https://chillihub1.github.io/chillihub-joiner/?placeId=%s&gameInstanceId=%s)")
        :format(placeId, jobId)
    local joinScript = string.format(
        "```lua\ngame:GetService('TeleportService'):TeleportToPlaceInstance(%s, '%s', game.Players.LocalPlayer)\n```",
        placeId, jobId
    )

    local footerTime = ("üß© Made by Grape Hub | H√¥m nay l√∫c %s:%s"):format(os.date("%H"), os.date("%M"))

    return {
        embeds = {{
            author = {name = "Brainrot Notify | Grape Hub"},
            color  = color or 0x000000,
            description = tableBlock ..
                "\nüÜî **Job ID (PC):** `" .. jobId .. "`\n" ..
                joinLink .. "\n\nüìú **Join Script:**\n" .. joinScript,
            footer = {text = footerTime},
        }}
    }
end
-- ==================================================
-- ‚öôÔ∏è EMBED INDEX (GI·ªêNG KI·ªÇU TR√äN NH∆ØNG KH√îNG JOIN/JOB)
-- ==================================================
local function makeIndexPayload(list)
    local players = tostring(#Players:GetPlayers()).."/"..tostring(Players.MaxPlayers)
    local lines = {}
    table.insert(lines, ("üë• Players: %s"):format(players))
    table.insert(lines, "üè∑Ô∏è Name              üí∞ Money/s")

    local COLUMN_POS = 22
    for _, t in ipairs(list) do
        local name = t.name or "Unknown"
        local gen  = t.generation or "?"
        if utf8.len(name) > COLUMN_POS - 2 then
            name = string.sub(name, 1, COLUMN_POS - 5) .. "..."
        end
        local pad = math.max(0, COLUMN_POS - utf8.len(name))
        table.insert(lines, string.format("%s%s%s", name, string.rep(" ", pad), gen))
    end
    local tableBlock = "```\n" .. table.concat(lines, "\n") .. "\n```"
    local footerTime = ("üß© Made by Grape Hub | H√¥m nay l√∫c %s:%s"):format(os.date("%H"), os.date("%M"))

    return {
        embeds = {{
            author = {name = "Brainrot Notify | Grape Hub"},
            color  = 0x000000,
            description = tableBlock,
            footer = {text = footerTime},
        }}
    }
end
-- ==================================================
-- ‚öôÔ∏è G·ª¨I WEBHOOK CH√çNH (logic cu·ªëi)
--  - LOW: 1‚Äì9M ‚Üí full (job/join/script)
--  - HIGH: 10M+ ‚Üí full (job/join/script)
--      * N·∫øu t√™n tr√πng SPECIAL ‚Üí delay 10s
--  - INDEX: 50M+ ‚Üí ch·ªâ t√™n + ti·ªÅn
--  - SPECIAL: t√™n thu·ªôc specialList ‚Üí g·ª≠i ƒë·∫ßu ti√™n (full)
-- ==================================================
local lastJobIdSent = nil
local function sendWebhook(foundTargets)
    if not foundTargets or #foundTargets == 0 then return end
    local placeId, jobId = game.PlaceId, game.JobId
    if jobId == lastJobIdSent then return end
    lastJobIdSent = jobId

    local groupLow, groupHigh, groupIndex, groupSpecial = {}, {}, {}, {}

    for _, t in ipairs(foundTargets) do
        local name = t.name or "Unknown"
        local gen  = t.generation or "N/A"
        if not isTarget(name) then continue end

        local val = parseGeneration(gen)
        if val <= 0 then continue end

        if isSpecial(name) then
            table.insert(groupSpecial, {name = name, generation = gen})
        end
        if val >= 50 then
            table.insert(groupIndex,  {name = name, generation = gen})
        end
        if val >= 10 then
            table.insert(groupHigh,   {name = name, generation = gen})
        elseif val >= 1 then
            table.insert(groupLow,    {name = name, generation = gen})
        end
    end

    -- Kh√¥ng c√≥ g√¨ h·ª£p l·ªá
    if #groupLow == 0 and #groupHigh == 0 and #groupIndex == 0 and #groupSpecial == 0 then
        print("‚ÑπÔ∏è Kh√¥ng c√≥ target h·ª£p l·ªá ƒë·ªÉ g·ª≠i webhook.")
        return
    end

    print("üì§ B·∫Øt ƒë·∫ßu g·ª≠i webhook ...")

    -- SPECIAL g·ª≠i ƒê·∫¶U TI√äN (full)
    if #groupSpecial > 0 then
        safeSend(webhook_special, makePayload(groupSpecial, 0xFFD700, placeId, jobId))
        print(("üö® Special: %d item(s)"):format(#groupSpecial))
    end

    -- INDEX (50M+) g·ª≠i ngay (ch·ªâ t√™n + ti·ªÅn)
    if #groupIndex > 0 then
        safeSend(webhook_index, makeIndexPayload(groupIndex))
        print(("üìò Index(50M+): %d item(s)"):format(#groupIndex))
    end

    -- LOW (1‚Äì9M) g·ª≠i ngay (full)
    if #groupLow > 0 then
        safeSend(webhook_low, makePayload(groupLow, 0x00FF00, placeId, jobId))
        print(("üì© Low(1‚Äì9M): %d item(s)"):format(#groupLow))
    end

    -- HIGH (10M+) t√°ch special tr√πng ‚Üí delay 10s; c√≤n l·∫°i g·ª≠i ngay
    if #groupHigh > 0 then
        local normalHigh, delayedHigh = {}, {}
        local specialSet = {}
        for _, s in ipairs(groupSpecial) do
            specialSet[string.lower(s.name or "")] = true
        end
        for _, h in ipairs(groupHigh) do
            if specialSet[string.lower(h.name or "")] then
                table.insert(delayedHigh, h)
            else
                table.insert(normalHigh,  h)
            end
        end

        if #normalHigh > 0 then
            safeSend(webhook_high, makePayload(normalHigh, 0x1A1AFF, placeId, jobId))
            print(("üî• High(10M+) ngay: %d item(s)"):format(#normalHigh))
        end
        if #delayedHigh > 0 then
            task.delay(10, function()
                safeSend(webhook_high, makePayload(delayedHigh, 0x1A1AFF, placeId, jobId))
                print(("‚è±Ô∏è High(10M+) tr√πng special g·ª≠i sau 10s: %d item(s)"):format(#delayedHigh))
            end)
        end
    end
end
-- ==================================================
-- CHECK TARGETS + LOOP (gi·ªØ c∆° ch·∫ø qu√©t c≈©, qu√©t m·ªói 3s)
-- ==================================================
local function checkTargets()
    local foundTargets = {}
    for _, obj in ipairs(workspace:GetDescendants()) do
        if obj:IsA('TextLabel') and obj.Name == 'DisplayName' then
            local txt = string.lower(obj.LocalizedText or '')

            if string.upper(obj.LocalizedText or '') == 'FUSING' then
                continue
            end

            for _, name in ipairs(targets) do
                if string.find(txt, string.lower(name)) then
                    local parent = obj.Parent
                    local isStolen = false
                    local generation = 'N/A'

                    if parent then
                        local stolenLabel = parent:FindFirstChild('Stolen')
                        if stolenLabel and stolenLabel:IsA('TextLabel') then
                            local stolenText = string.upper(stolenLabel.LocalizedText or '')
                            if stolenText == 'FUSING' then
                                isStolen = true
                            end
                        end

                        for _, child in ipairs(parent:GetChildren()) do
                            if child:IsA('TextLabel') then
                                local childName = string.lower(child.Name or '')
                                local childText = child.LocalizedText or ''

                                if childName:find('generation') or childName:find('gen') then
                                    generation = childText ~= '' and childText or generation
                                    break
                                end

                                if childText:match('^G%d+') or childText:match('^G%d+%s') then
                                    generation = childText
                                    break
                                end
                            end
                        end
                    end

                    if not isStolen then
                        table.insert(foundTargets, { name = name, generation = generation })
                        print('‚úÖ Found valid target:', name, '| Generation:', generation)
                    else
                        print('‚ö†Ô∏è Skipped (FUSING):', name)
                    end
                    break
                end
            end
        end
    end
    return foundTargets
end

print('üéØ CT_WhiteScanner_V2 ƒëang ch·∫°y... (qu√©t m·ªói 3s)')

-- STARTUP: ƒë·ª£i map load billboard, retry 5s n·∫øu ch∆∞a c√≥
task.spawn(function()
    print("üïì ƒê·ª£i map load Billboard... (3s)")
    task.wait(3)
    local initialTargets = checkTargets()
    if #initialTargets > 0 then
        print("‚úÖ ƒê√£ t√¨m th·∫•y "..#initialTargets.." target, g·ª≠i ngay!")
        sendWebhook(initialTargets)
    else
        print("‚åõ Ch∆∞a ph√°t hi·ªán target n√†o, retry sau 5s...")
        task.delay(5, function()
            local retry = checkTargets()
            if #retry > 0 then
                print("üîÅ G·ª≠i l·∫°i webhook sau 5s ("..#retry.." targets)")
                sendWebhook(retry)
            else
                print("‚åõ Retry 5s: v·∫´n ch∆∞a c√≥ target.")
            end
        end)
    end
end)

-- Loop qu√©t ƒë·ªÅu ƒë·∫∑n
task.spawn(function()
    while task.wait(3) do
        local ok2, err = pcall(function()
            local t = checkTargets()
            if #t > 0 then sendWebhook(t) end
        end)
        if not ok2 then warn('‚ö†Ô∏è Scan loop error:', err) end
    end
end)

-- ==================================================
-- üöÄ CT AUTO JOIN (gi·ªØ nguy√™n, optional)
-- ==================================================
task.delay(5, function()
    local Players = game:GetService("Players")
    local HttpService = game:GetService("HttpService")
    local TeleportService = game:GetService("TeleportService")
    local LocalPlayer = Players.LocalPlayer

    local http_request_impl = nil
    if typeof(syn) == "table" and typeof(syn.request) == "function" then
        http_request_impl = syn.request
    elseif typeof(http_request) == "function" then
        http_request_impl = http_request
    elseif typeof(request) == "function" then
        http_request_impl = request
    elseif typeof(http) == "table" and typeof(http.request) == "function" then
        http_request_impl = http.request
    end

    if not http_request_impl then
        warn("‚ùå Kh√¥ng t√¨m th·∫•y HTTP request function (syn.request / http_request / request / http.request).")
        warn("üëâ H√£y b·∫≠t HTTP trong executor ho·∫∑c ƒë·ªïi executor.")
        return
    end

    local HTTP_URL = "http://127.0.0.1:8080/next"
    local RECENT_MAX = 300
    local recentQueue, recentSet = {}, {}
    local function pushRecent(jid)
        if not jid or jid == "" then return end
        if recentSet[jid] then return end
        table.insert(recentQueue, jid)
        recentSet[jid] = true
        if #recentQueue > RECENT_MAX then
            local old = table.remove(recentQueue, 1)
            if old then recentSet[old] = nil end
        end
    end

    local DELAY_AFTER_TRY = 5
    print(("[CT AutoJoin] B·∫Øt ƒë·∫ßu (URL=%s)  | Delay sau m·ªói l·∫ßn th·ª≠ = %ds"):format(HTTP_URL, DELAY_AFTER_TRY))

    task.spawn(function()
        while true do
            local ok_req, response = pcall(function()
                return http_request_impl({ Url = HTTP_URL, Method = "GET" })
            end)

            if not ok_req then
                warn("‚ùå HTTP request l·ªói:", response)
                task.wait(0.2)
            else
                local body = response and response.Body
                if type(body) ~= "string" or #body == 0 then
                    task.wait(0.2)
                else
                    local ok_json, data = pcall(function()
                        return HttpService:JSONDecode(body)
                    end)
                    if not ok_json or type(data) ~= "table" then
                        warn("‚ùå JSON decode l·ªói.")
                        task.wait(0.1)
                    else
                        local jobId = tostring(data.jobId or "")
                        local placeId = tonumber(data.placeId) or game.PlaceId

                        if jobId == "" or jobId == "null" or jobId == "nil" then
                            task.wait(0.05)
                        else
                            if recentSet[jobId] then
                                task.wait(0.05)
                            else
                                pushRecent(jobId)
                                print(("‚û° Teleport th·ª≠ JobId: %s  (place=%s)"):format(jobId, tostring(placeId)))
                                local ok_tp, err = pcall(function()
                                    TeleportService:TeleportToPlaceInstance(placeId, jobId, LocalPlayer)
                                end)
                                if not ok_tp then
                                    warn("‚ö†Ô∏è Teleport failed:", err)
                                else
                                    print("‚úÖ Teleport call ƒë√£ g·ª≠i (game s·∫Ω t·ª± x·ª≠ l√Ω).")
                                end
                                task.wait(DELAY_AFTER_TRY)
                            end
                        end
                    end
                end
            end
        end
    end)
end)
